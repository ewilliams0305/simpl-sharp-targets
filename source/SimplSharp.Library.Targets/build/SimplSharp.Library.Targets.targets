<?xml version="1.0" encoding="UTF-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003" ToolsVersion="4.0">

  <PropertyGroup>
    <ProduceReferenceAssembly>False</ProduceReferenceAssembly>
    <CopyLocalLockFileAssemblies>False</CopyLocalLockFileAssemblies>
  </PropertyGroup>

  <!-- Data Variables -->

  <PropertyGroup>
    <ToolCommand>dotnet simplsharp clz</ToolCommand>
    <!-- 
        Tool version will be replaced during the CI actions.  
        This will ensure this package always uses the correct version of the tooling it targets.
        This will happen from github actions prior to the dotnet build command.
    -->
    <ToolVersion>0.1.3</ToolVersion>
    <ArchiveExtension>.clz</ArchiveExtension>
  </PropertyGroup>

  <!-- Copy Directory.Build.targets  -->
  <Target Name="CopyDirectoryBuildTargets" BeforeTargets="BeforeBuild">
    <ItemGroup>
      <NuGetPackagePath Include="$(NuGetPackageRoot)simplsharp.library.targets\$(ToolVersion)\content\Directory.Build.targets" />
    </ItemGroup>
    <Message Importance="high" Text="Copying Directory.Build.targets to project directory $(NuGetPackagePath)" />
    <Copy SourceFiles="@(NuGetPackagePath)" DestinationFolder="$(MSBuildProjectDirectory)" />
  </Target>

  <!-- Output Provided -->

  <PropertyGroup>
    <IsCustomOutputPath Condition="'$(OutputPath)' != '$(BaseOutputPath)bin\$(Configuration)\'">true</IsCustomOutputPath>
  </PropertyGroup>

  <!-- Clean Up -->

  <Target Name="SimplSharpCleanup" AfterTargets="BeforeBuild;AfterClean">
    <Delete Files="$(OutputPath)\ProgramInfo.config" ContinueOnError="true" />
    <Delete Files="$(OutputPath)\$(TargetName)$(ArchiveExtension)" ContinueOnError="true" />
  </Target>

  <!-- Installation -->

  <Target Name="InstallTools" BeforeTargets="SimplSharpBuildArchive">
    <Message Importance="high" Text="Checking for SimplSharp.Tool updates $(ToolVersion)" />
    <Exec Command="dotnet tool install SimplSharp.Tool --version $(ToolVersion) --create-manifest-if-needed --allow-downgrade" />
  </Target>

  <!-- Execute Actions -->

  <Target Name="SimplSharpBuildArchive" BeforeTargets="AfterBuild">
    <Message Importance="high" Text="----> Creating SIMPL Sharp Archive $(OutputPath)\$(AssemblyName).dll ----> $(OutputPath)" Condition="'$(IsCustomOutputPath)' == 'true'"/>
    <Exec Command="$(ToolCommand) -p $(OutputPath)\$(AssemblyName).dll -d $(OutputPath)" Condition="'$(IsCustomOutputPath)' == 'true'" />

    <Message Importance="high" Text="----> Creating SIMPL Sharp Archive $(MSBuildProjectDirectory)\$(OutputPath)$(AssemblyName).dll ----> $(MSBuildProjectDirectory)\$(OutputPath)" Condition="'$(IsCustomOutputPath)' != 'true'"/>
    <Exec Command="$(ToolCommand) -p $(MSBuildProjectDirectory)\$(OutputPath)$(AssemblyName).dll" Condition="'$(IsCustomOutputPath)' != 'true'" />
  </Target>

</Project>